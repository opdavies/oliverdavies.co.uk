---
- name: Install Composer dependencies
  composer:
   command: install
   working_dir: "{{ ansistrano_release_path.stdout }}"

- name: Generate the site once without assets
  command: composer run prod
  args:
   chdir: "{{ ansistrano_release_path.stdout }}"

- name: Install Node dependencies
  command: yarn install
  args:
   chdir: "{{ ansistrano_release_path.stdout }}"

- name: Install Webpack Encore assets
  command: './node_modules/.bin/encore production'
  args:
   chdir: "{{ ansistrano_release_path.stdout }}"

- name: Generate the site, including assets
  command: composer run prod
  args:
   chdir: "{{ ansistrano_release_path.stdout }}"
